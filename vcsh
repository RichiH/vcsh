#!/bin/sh

[ -n "$VCSH_DEBUG" ]      && set -x
[ -z "$XDG_CONFIG_HOME" ] && XDG_CONFIG_HOME="$HOME/.config"
[ -z "$VCSH_BASE" ]       && VCSH_BASE="$XDG_CONFIG_HOME/vcsh/repo.d"

SELF=$(basename $0)

help() {
	echo "usage: $SELF <args>

   clone <remote> \\
         [<repo>]       Clone from an existing repository
   help                 Display this help text
   delete               Delete an existing repository
   enter                Enter repository; spawn new $SHELL
   init <repo>          Initialize a new repository
   list                 List all repositories
   run <repo> \\
       <command>        Use this repository

   seed-gitignore \\
   <repo>               Seed .gitignore.d/<repo> from git ls-files
   setup                Set up repository with recommended settings

   <repo> <git command> Special command that allows you to run git commands
                        directly without having to type so much ;)" >&2
}

debug() {
	[ -n "$VCSH_DEBUG" ] && echo "$SELF: debug: $@"
}

verbose() {
	if [ -n "$VCSH_DEBUG" ] || [ -n "$VCSH_VERBOSE" ]; then echo "$SELF: verbose: $@"; fi
}

error () {
	echo "$SELF: error: $1" >&2
}

fatal () {
	echo "$SELF: fatal error: $1" >&2
	exit $2
}

info () {
	echo "$SELF: info: $1"
}

setup() {
	git config core.worktree     "$GIT_WORK_TREE"
	git config core.excludesfile ".gitignore.d/$VCSH_REPO_NAME"
	git config vcsh.vcsh         'true'
	touch   "$HOME/.gitignore.d/$VCSH_REPO_NAME"
	git add "$HOME/.gitignore.d/$VCSH_REPO_NAME"
}

init() {
	verbose "init() begin"
	[ ! -e "$GIT_DIR" ] || fatal "$GIT_DIR exists" 10
	export GIT_WORK_TREE="$HOME"
	mkdir -p "$GIT_WORK_TREE"
	cd "$GIT_WORK_TREE" || fatal "could not enter $GIT_WORK_TREE" 11
	cd "$GIT_WORK_TREE"
	git init
	setup
	verbose "init() end"
}

use() {
	verbose "use() begin"
	if [ ! -d "$GIT_DIR" ]; then
		error "no repository found for '$VCSH_REPO_NAME'"
		return 12
	fi
	export GIT_DIR
	export GIT_WORK_TREE="$(git config --get core.worktree)"
	export VCSH_DIRECTORY="$VCSH_REPO_NAME"
	verbose "use() end"
}


if [ "$1" = 'clone' ]; then
	export VCSH_COMMAND="$1"
	GIT_REMOTE="$2"
	export GIT_REMOTE
	VCSH_REPO_NAME="$3"
	[ -z "$VCSH_REPO_NAME" ] && VCSH_REPO_NAME=$(basename "$GIT_REMOTE" .git)
	export VCSH_REPO_NAME
	export GIT_DIR="$VCSH_BASE/$VCSH_REPO_NAME.git"
elif [ "$1" = 'delete' ] ||
     [ "$1" = 'enter' ] ||
     [ "$1" = 'init' ] ||
     [ "$1" = 'run' ] ||
     [ "$1" = 'seed-gitignore' ] ||
     [ "$1" = 'setup' ]; then
	[ -z $2 ] && fatal "$1: please specify repository to work on" 1
	export VCSH_COMMAND="$1"
	export VCSH_REPO_NAME="$2"
	export GIT_DIR="$VCSH_BASE/$VCSH_REPO_NAME.git"
	shift 2
	export VCSH_EXTERNAL_COMMAND="$*"
	if [ "$VCSH_COMMAND" = 'run' ]; then
		[ -z "$VCSH_EXTERNAL_COMMAND" ] && fatal "$1 $2: please specify a command" 1
	fi
elif [ "$1" = 'help' ] ||
     [ "$1" = 'list' ]; then
	export VCSH_COMMAND="$1"
else
	[ -z $1 ] && help && exit 0
	export VCSH_COMMAND='run'
	export VCSH_REPO_NAME="$1"
	export GIT_DIR="$VCSH_BASE/$VCSH_REPO_NAME.git"
	[ -d $GIT_DIR ] || { help; exit 1; }
	shift 1
	export VCSH_EXTERNAL_COMMAND="git $*"
fi


for check_directory in "$VCSH_BASE" "$HOME/.gitignore.d"
do
	if [ ! -d "$check_directory" ]; then
		if [ -e "$check_directory" ]; then
			fatal "$check_directory exists but is not a directory" 13
		else
			info "attempting to create $check_directory"
			mkdir -p "$check_directory" || fatal "could not create $check_directory" 50
		fi
	fi
done


if [ "$VCSH_COMMAND" = 'clone' ]; then
	verbose "clone begin"
	init
	git remote add origin "$GIT_REMOTE"
	git config branch.master.remote origin
	git config branch.master.merge  refs/heads/master
	git fetch
	for object in $(git ls-tree -r origin/master | awk '{print $4}'); do
		[ -e "$object" ] &&
			error "$object exists." &&
			VCSH_CONFLICT=1;
	done
	[ "$VCSH_CONFLICT" = '1' ] &&
		fatal "will stop after fetching and not try to merge!
  Once this situation has been resolved, run 'vcsh run <foo> git pull' to finish cloning.\n" 17
	git merge origin/master
	verbose "clone end"

#elif [ "$VCSH_COMMAND" = 'help' ] || [ "$#" -eq 0 ]; then
elif [ "$VCSH_COMMAND" = 'help' ]; then
	help

elif [ "$VCSH_COMMAND" = 'delete' ]; then
	verbose "delete begin"
	old_dir="$PWD"
	cd "$HOME"
	use || exit $?
	info "This operation WILL DETROY DATA!"
	files=$(git ls-files)
	echo "These files will be deleted:

$files

AGAIN, THIS WILL DELETE YOUR DATA!
To continue, type \"Yes, do as I say\""
	read answer
	[ "x$answer" = "xYes, do as I say" ] || exit 16
	for file in $files; do
		rm -f $file || info "could not delete '$file', continuing with deletion"
	done
	rm -rf "$GIT_DIR" || info "could not delete '$GIT_DIR'"
	cd "$old_dir"
	verbose "delete end"

elif [ "$VCSH_COMMAND" = 'enter' ]; then
	verbose "enter begin"
	use || exit $?
	$SHELL
	verbose "enter end"

elif [ "$VCSH_COMMAND" = 'init' ]; then
	verbose "init begin"
	init
	verbose "init end"

elif [ "$VCSH_COMMAND" = 'list' ]; then
	verbose "list begin"
	for i in "$VCSH_BASE"/*.git; do
		echo $(basename "$i" .git)
	done
	verbose "list end"

elif [ "$VCSH_COMMAND" = 'run' ]; then
	verbose "run begin"
	use || exit $?
	$VCSH_EXTERNAL_COMMAND
	verbose "run end"

elif [ "$VCSH_COMMAND" = 'seed-gitignore' ]; then
	verbose "seed-gitignore begin"
	use || exit $?
	# Switching directory as this has to be executed from $HOME to be of any use.
	# Going back into old directory at the end in case `vcsh use` is reactivated.
	old_dir="$PWD"
	cd "$HOME"
	gitignores=$(for file in $(git ls-files); do
		while true; do
			echo $file; new="${file%/*}"
			[ "$file" = "$new" ] && break
			file="$new"
		done;
	done | sort -u)
	tempfile=$(mktemp) || fatal "could not create tempfile" 51
	echo '*' > "$tempfile"
	for gitignore in $gitignores; do
		echo "$gitignore" | sed 's/^/!/' >> "$tempfile"
		[ -d "$gitignore" ] && echo "$gitignore/*" | sed 's/^/!/'>> "$tempfile"
	done
	diff -N "$tempfile" "$HOME/.gitignore.d/$VCSH_REPO_NAME" > /dev/null &&
		rm -f "$tempfile" &&
		exit
	if [ -e "$HOME/.gitignore.d/$VCSH_REPO_NAME" ]; then
		info "$HOME/.gitignore.d/$VCSH_REPO_NAME differs from new data, moving it to $HOME/.gitignore.d/$VCSH_REPO_NAME.bak"
		mv -f "$HOME/.gitignore.d/$VCSH_REPO_NAME" "$HOME/.gitignore.d/$VCSH_REPO_NAME.bak" ||
			fatal "could not move $HOME/.gitignore.d/$VCSH_REPO_NAME to $HOME/.gitignore.d/$VCSH_REPO_NAME.bak" 53
	fi
	mv -f "$tempfile" "$HOME/.gitignore.d/$VCSH_REPO_NAME" ||
		fatal "could not move $tempfile to $HOME/.gitignore.d/$VCSH_REPO_NAME" 53
	cd "$old_dir"
	verbose "seed-gitignore end"

elif [ "$VCSH_COMMAND" = 'setup' ]; then
	verbose "seed-gitignore begin"
	use   || exit $?
	setup || exit $?
	verbose "seed-gitignore end"

else
	verbose "defaulting to calling help()"
	help
	fatal "You should never reach this code. File a bug, please." 99

fi
